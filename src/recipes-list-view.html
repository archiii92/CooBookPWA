<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">

<dom-module id="recipes-list-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

      paper-button {
        margin-bottom: 10px;
      }
    </style>
    <paper-button raised on-tap="_add">Добавить рецепт</paper-button>
    <paper-button raised on-tap="_remove">Удалить рецепт</paper-button>

    <vaadin-grid aria-label="Dynamic Data Example" items="[[items]]">

      <vaadin-grid-column width="50px" flex-grow="0">
        <template class="header">#</template>
        <template>[[index]]</template>
      </vaadin-grid-column>

      <vaadin-grid-column>
        <template class="header">First Name</template>
        <template>[[item.firstName]]</template>
      </vaadin-grid-column>

      <vaadin-grid-column>
        <template class="header">Last Name</template>
        <template>[[item.lastName]]</template>
      </vaadin-grid-column>

    </vaadin-grid>
  </template>

  <script>
    Polymer({
        is: 'recipes-list-view',

        properties: {
            route: {
                type: String,
                notify: true
            },
            dbName: {
                type: String,
                value: 'CooBookBase'
            },
            storeName: {
                type: String,
                value: 'CooBookRecipeObjectStore'
            },
            indexedDB: Object,
            recipes: Array
        },

        ready() {
            if (!this.indexedDB) this.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
            this._connectDB(this._getRecipes);
        },

        _connectDB(f){
            let self = this;
            let request = this.indexedDB.open(this.dbName, 1);
            request.onerror = (err) => {
                console.log(err);
            };
            request.onsuccess = () => {
                f.call(self, request.result);
            };
            request.onupgradeneeded = (e) => {
                e.currentTarget.result.createObjectStore('CooBookRecipeObjectStore', {autoIncrement : true});
                e.currentTarget.result.createObjectStore('CooBookIngredientsObjectStore', {autoIncrement : true});
                self._connectDB(f);
            };
        },

        _getRecipes(db) {
            //debugger;
            let self = this;
            this.recipes = [];

            let objectStore = db.transaction([this.storeName], "readonly").objectStore(this.storeName);

            objectStore.openCursor().onsuccess = (event) => {
                let cursor = event.target.result;
                if (cursor) {
                    self.recipes.push(cursor.value);
                    cursor.continue();
                }
            };
        },

        _add: function () {
            this.set('route.path', '/recipe-create-view');
        },

        _remove: function () {
            this.pop('items');
        }
    });
  </script>
</dom-module>
